SELECT
gll.LEDGER_NAME,
--gca.PERIOD_NAME,
gca.CURRENCY,
gca.ENTITY,
Entity_Desc.DESCRIPTION,
--gca.RC,
gca.ACCOUNT,
Account_Desc.DESCRIPTION ACCOUNT_DESCRIPTION,
gca.CONCATENATED_SEGMENTS,
SUM(gca.BEG_BAL) BEG_BAL,
SUM(gca.PERIOD_ACTIVITY) PERIOD_ACTIVITY,
SUM(gca.END_BAL) END_BAL
--gca.Entity||' - '||Entity_Desc.DESCRIPTION "Company",
--gca.RC,

--gca.ENTITY||gca.ACCOUNT "UNIQUE",
--gca.PERIOD_DEBITS,
--gca.PERIOD_CREDITS,


FROM
(select 
GL_LEDGERS.LEDGER_ID||gcc.SEGMENT1 "UNIQUE1",
gcc.SEGMENT1 ENTITY,
--gcc.SEGMENT2 RC,
gcc.SEGMENT3 ACCOUNT,
gcc.CONCATENATED_SEGMENTS,
--glb.PERIOD_NAME
--case when glb.PERIOD_NAME = :FROM_PERIOD_NAME then :TO_PERIOD_NAME
--else glb.PERIOD_NAME end PERIOD_NAME,


--(select unique case when glb.PERIOD_NAME is null then glb.PERIOD_NAME else glb.PERIOD_NAME end from APPS.GL_BALANCES where glb.PERIOD_NAME IN (:TO_PERIOD_NAME)) PERIOD_NAME,
CASE glb.CURRENCY_CODE
WHEN 'STAT' THEN NULL ELSE glb.CURRENCY_CODE END CURRENCY,
SUM(DECODE(glb.PERIOD_NAME,:FROM_PERIOD_NAME,NVL(glb.BEGIN_BALANCE_DR,0) - NVL(glb.BEGIN_BALANCE_CR,0),0)) "BEG_BAL",
--SUM((DECODE(glb.PERIOD_NAME,:TO_PERIOD_NAME,NVL(glb.PERIOD_NET_DR,0) + NVL(glb.BEGIN_BALANCE_DR,0),0))-(DECODE(glb.period_name,:FROM_PERIOD_NAME,NVL(glb.BEGIN_BALANCE_DR,0),0))) "PERIOD_DEBITS",
--SUM((DECODE(glb.PERIOD_NAME,:TO_PERIOD_NAME,-NVL(glb.PERIOD_NET_CR,0) - NVL(glb.BEGIN_BALANCE_CR,0),0))-(DECODE(glb.period_name,:FROM_PERIOD_NAME,- NVL(glb.BEGIN_BALANCE_CR,0),0))) "PERIOD_CREDITS",
(SUM((DECODE(glb.PERIOD_NAME,:TO_PERIOD_NAME,NVL(glb.PERIOD_NET_DR,0) + NVL(glb.BEGIN_BALANCE_DR,0),0))-(DECODE(glb.period_name,:FROM_PERIOD_NAME,NVL(glb.BEGIN_BALANCE_DR,0),0)))) + (SUM((DECODE(glb.PERIOD_NAME,:TO_PERIOD_NAME,-NVL(glb.PERIOD_NET_CR,0) - NVL(glb.BEGIN_BALANCE_CR,0),0))-(DECODE(glb.period_name,:FROM_PERIOD_NAME,- NVL(glb.BEGIN_BALANCE_CR,0),0)))) "PERIOD_ACTIVITY",
SUM(DECODE(glb.PERIOD_NAME,:TO_PERIOD_NAME,NVL(glb.BEGIN_BALANCE_DR,0) - NVL(glb.BEGIN_BALANCE_CR,0) + NVL(glb.PERIOD_NET_DR,0) - NVL(glb.PERIOD_NET_CR,0),0)) "END_BAL"
--SUM(NVL(glb.BEGIN_BALANCE_DR,0) - NVL(glb.BEGIN_BALANCE_CR,0)) BEG_BAL,
--SUM(NVL(glb.PERIOD_NET_DR,0) - NVL(glb.PERIOD_NET_CR,0)) PERIOD_ACTIVITY,
--SUM(NVL(glb.BEGIN_BALANCE_DR,0) - NVL(glb.BEGIN_BALANCE_CR,0) + NVL(glb.PERIOD_NET_DR,0) - NVL(glb.PERIOD_NET_CR,0)) END_BAL
--
--

from
APPS.gl_code_combinations_kfv gcc, 
APPS.GL_BALANCES glb,
APPS.GL_LEDGERS
  
where gcc.CODE_COMBINATION_ID = glb.CODE_COMBINATION_ID 
AND gcc.DETAIL_POSTING_ALLOWED = 'Y'
AND glb.actual_flag = 'A'
AND gcc.summary_flag = 'N'
AND glb.TRANSLATED_FLAG IS NULL
AND GL_LEDGERS.LEDGER_CATEGORY_CODE IN ('PRIMARY','NONE')
AND glb.LEDGER_ID = GL_LEDGERS.LEDGER_ID
--AND gcc.SEGMENT1 IN ('401') 
--AND gcc.SEGMENT2 IN ('22063') 
--AND gcc.SEGMENT3 IN ('15010300','21504400','16535500','22509800')
--AND gcc.SEGMENT4 IN ('000000') 
--AND gcc.SEGMENT5 IN ('0000000') 
--AND gcc.SEGMENT6 IN ('0000')
--AND gcc.SEGMENT7 IN ('000') 
--AND gcc.SEGMENT8 IN ('0000000') 
--AND gcc.SEGMENT9 IN ('0000')
--AND gcc.SEGMENT10 IN ('0000000') 
AND glb.PERIOD_NAME IN (:FROM_PERIOD_NAME,:TO_PERIOD_NAME)
--AND glb.PERIOD_NAME IN ('OCT-17','SEP-17','MAY-17','JUN-17','JUL-17','AUG-17')

group by
GL_LEDGERS.LEDGER_ID||gcc.SEGMENT1,
gcc.SEGMENT1,
--gcc.SEGMENT2,
gcc.SEGMENT3,
gcc.CONCATENATED_SEGMENTS,
--glb.PERIOD_NAME,
glb.CURRENCY_CODE) gca,

(select 
GL_LEDGERS.LEDGER_ID||GL_LEDGER_NORM_SEG_VALS.SEGMENT_VALUE "UNIQUE2",
GL_LEDGERS.LEDGER_ID,
GL_LEDGER_NORM_SEG_VALS.SEGMENT_VALUE "ENTITY",
GL_LEDGERS.NAME "LEDGER_NAME"

from
APPS.GL_LEDGER_NORM_SEG_VALS,
APPS.GL_LEDGERS

WHERE  GL_LEDGER_NORM_SEG_VALS.LEDGER_ID = GL_LEDGERS.LEDGER_ID
AND GL_LEDGERS.LEDGER_CATEGORY_CODE IN ('PRIMARY','NONE')

ORDER BY
GL_LEDGER_NORM_SEG_VALS.SEGMENT_VALUE) gll,

APPS.FND_FLEX_VALUES Account_ID,
APPS.FND_FLEX_VALUES_TL Account_Desc,

APPS.FND_FLEX_VALUES Entity_ID,
APPS.FND_FLEX_VALUES_TL Entity_Desc


WHERE gca.CURRENCY IS NOT NULL
AND Account_Desc.FLEX_VALUE_ID = Account_ID.FLEX_VALUE_ID
AND Account_ID.FLEX_VALUE_SET_ID = 1014877
AND Account_ID.FLEX_VALUE = gca.ACCOUNT
AND gca.UNIQUE1 = gll.UNIQUE2

AND (gca.BEG_BAL <> 0
--or gca.PERIOD_DEBITS <> 0
--or gca.PERIOD_CREDITS <> 0
or PERIOD_ACTIVITY <> 0
or gca.END_BAL <> 0)

--AND gca.ENTITY IN ('401','464') 

AND gll.LEDGER_NAME LIKE ('%AUS%')

AND Entity_Desc.FLEX_VALUE_ID = Entity_ID.FLEX_VALUE_ID
AND Entity_ID.FLEX_VALUE_SET_ID = 1014875
AND Entity_ID.FLEX_VALUE = gca.ENTITY

GROUP BY
gll.LEDGER_NAME,
gca.ENTITY,
--gca.RC,
gca.ACCOUNT,
gca.CONCATENATED_SEGMENTS,  
Account_Desc.DESCRIPTION,
Entity_Desc.DESCRIPTION,
gca.CURRENCY
--gca.PERIOD_NAME
--gca.BEG_BAL,
--gca.PERIOD_DEBITS,
--gca.PERIOD_CREDITS,
--gca.PERIOD_ACTIVITY,
--gca.END_BAL

ORDER BY
gca.ENTITY,
gca.ACCOUNT